{"pageProps":{"title":"Always use Promise.all() (or any other Promise's method) for array of promises","tags":["JavaScript/JS"],"publishedOn":"2023-09-16T16:01:00.000Z","dirName":"post011_always_use_promise_all","content":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    div: \"div\",\n    pre: \"pre\",\n    code: \"code\",\n    span: \"span\",\n    ul: \"ul\",\n    li: \"li\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.p, {\n      children: \"At my job one of our services was crashing from time to time, but quite rarely.\\nBecause it crashed only at a large interval of a few days it was not given that\\nmuch attention to it. The pod would crash and another pod would immediately be\\ncreated and ready to serve the requests.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"But one day our internal DNS failed and all the pods of the service crashed.\\nAfter investigation we have seen that the DNS failed, but the service should\\nhave not crashed, but in return it should serve a 500 to the clients.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"After analyzing the service's code I found this: our service was calling other\\nservices to retrieve the required data. All of the requests to the other\\nservices were handled inside a try/catch block, but something else was going\\nbad. Very bad. Very bad because the thrown exception was that the service's\\ncode was not handling a promise inside a try/catch block. But how?\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Let see the next code:\"\n    }), \"\\n\", _jsx(_components.div, {\n      className: \"remark-highlight\",\n      children: _jsx(_components.pre, {\n        className: \"language-javascript  line-numbers\",\n        children: _jsxs(_components.code, {\n          className: \"language-javascript\",\n          children: [_jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" streams \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token function-variable function\",\n            children: \"firstStepStream\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [\"req\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" res\"]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=>\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n        res\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"streams\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"[\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"]\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token function-variable function\",\n            children: \"intermediateStep1Stream\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [\"req\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" res\"]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=>\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n        res\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"streams\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"push\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=>\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" response \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"doRequestToSomeService\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"req\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"token comment\",\n            children: \"// Do things\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"token comment\",\n            children: \"// ...\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token function-variable function\",\n            children: \"intermediateStep2Stream\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [\"req\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" res\"]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=>\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n        res\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"streams\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"push\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=>\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" response2 \", _jsx(_components.span, {\n            className: \"token operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token function\",\n            children: \"doRequestToSomeService2\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"req\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"token comment\",\n            children: \"// Do things\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"token comment\",\n            children: \"// ...\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \",\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token function-variable function\",\n            children: \"finalStepStream\"\n          }), _jsx(_components.span, {\n            className: \"token operator\",\n            children: \":\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"async\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsxs(_components.span, {\n            className: \"token parameter\",\n            children: [\"req\", _jsx(_components.span, {\n              className: \"token punctuation\",\n              children: \",\"\n            }), \" res\"]\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token arrow operator\",\n            children: \"=>\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"for\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"const\"\n          }), \" stream \", _jsx(_components.span, {\n            className: \"token keyword\",\n            children: \"in\"\n          }), \" res\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token property-access\",\n            children: \"streams\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"try\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n                \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"await\"\n          }), \" stream\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"catch\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), \"error\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), \" \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"{\"\n          }), \"\\n                res\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"status\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token number\",\n            children: \"500\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n                res\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \".\"\n          }), _jsx(_components.span, {\n            className: \"token method function property-access\",\n            children: \"end\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"(\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \")\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n                \", _jsx(_components.span, {\n            className: \"token keyword control-flow\",\n            children: \"return\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\\n        \", _jsx(_components.span, {\n            className: \"token comment\",\n            children: \"// ...\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \"}\"\n          }), _jsx(_components.span, {\n            className: \"token punctuation\",\n            children: \";\"\n          }), _jsxs(_components.span, {\n            \"aria-hidden\": \"true\",\n            className: \"line-numbers-rows\",\n            children: [_jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            }), _jsx(_components.span, {\n              className: \"\"\n            })]\n          }), \"\\n\"]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"What is wrong here? Well, without much knowledge of JavaScript everything looks\\nfine. But then why the code fails in some situations?\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"If only one promise from \", _jsx(_components.code, {\n        children: \"res.streams\"\n      }), \" fails then our code handle it very fine\\nand will respond to the client with the 500 status code.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"But if both promises fails then our code will crash.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Why? Because we are not handling the second failed promise. When the first\\npromise get rejected it triggers the \", _jsx(_components.code, {\n        children: \"catch\"\n      }), \" block and in our \", _jsx(_components.code, {\n        children: \"catch\"\n      }), \" block of\\ncode we have a \", _jsx(_components.code, {\n        children: \"return\"\n      }), \" that will break the loop and our second promise will\\nnot have the change to be checked thus crashing the service with the proper\\nerror (that we are not handling a promise).\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Yes, we can done it correctly using the foor loop (or any loop) as long as we\\ncheck every single promise we have. But why? We already have special methods\\ninside the \", _jsx(_components.code, {\n        children: \"Promise\"\n      }), \" object for handling all the cases we would want:\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.code, {\n          children: \"Promise.all()\"\n        }), \" for when we want for all the promises to succeed;\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.code, {\n          children: \"Promise.allSettled()\"\n        }), \" for when we just want for all the promises to be done; will never reject;\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.code, {\n          children: \"Promise.any()\"\n        }), \" for when we want at least one promise to succeed; first one to succeed will be returned; if all fails when the method fails;\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.code, {\n          children: \"Promise.race()\"\n        }), \" for when we want the fastest promise to succeed.\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"And using the methods inside the \", _jsx(_components.code, {\n        children: \"Promise\"\n      }), \" object allow us the benefit of\\nbetter internal engine optimizations.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Read more about the Promise object here:\\n\", _jsx(\"a\", {\n        href: \"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise\",\n        rel: \"noopener noreferrer\",\n        target: \"_blank\",\n        children: \"MDN Web Docs: Promise\"\n      })]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}},"skip":null},"__N_SSG":true}